@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration
@{
    var apiUrl = Configuration["AppSettings:ApiUrl"];
    ViewBag.ApiUrl = apiUrl;
}

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">

<style>
    label {
        top: 0;
        transform: translateY(0);
        font-size: 1rem;
        font-weight: 700;
    }

    .error {
        color: red;
        font-size: 0.9rem;
    }



    .container {
        margin-top: 30px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        border-radius: 17px;
        padding: 40px;
        background-color: #fff;
        font-family: 'Roboto Mono', monospace;
        margin-left: auto;
        margin-right: auto;
    }

    .form-control {
        border-color: unset;
    }
</style>
<body style="
  background-image: -webkit-linear-gradient( 136deg,rgb(0,0,70) 0%,rgb(28,181,224) 100%);
">
    <div class="container itemClass">
        <div class="row  " id="BillForm" style=" border-radius: 17px;">

            <div class="row  mb-3">
                <span style="text-align: center; font-size: 28px;">Create Bill</span>
            </div>


            <div class="row">


                <div class="col mb-3 " >
                    <div class="ui-widget">
                        <label class="form-label mt-2" for="billcustomernameTags" style="color:black">Customer Name</label>
                        <input type="text" class=" form-control  " id="billcustomernameTags" placeholder="Select Customer" />
         
                    </div>          
                    <div>
                        <label class="form-label mt-2" style="color:black">Outstanding Amount</label>
                        <input type="text" class="form-control" name="" id="billCustomerOutstandingAmount">
                    </div>
                    <div>
                        <label class="form-label mt-2" style="color:black">Outstanding Limit</label>
                        <input type="text" class="form-control" name="" id="billCustomerOutstandingLimit">
                    </div>
                    <div>
                        
                        <label class="form-label mt-2" style="color:black"> Customer Details</label>
                        <textarea type="text-area " class="form-control" name="s" id="billCustomerDetails"></textarea>

                    </div>


                </div>


                <div class="col mb-3">
                    <label class="form-label mt-2" style="color:black"> Bill Number</label>
                    <input type="text" class="form-control" name="" id="billNumber">

                    <label for="strStudob " class="form-label mt-2">Bill Date </label>
                    <input type="text" class="form-control " name="" id="billDate">
                    <label class="form-label mt-3" style="color:black"> Payment Type</label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="inlineRadioOptions" id="billCredit" value="Credit" checked />
                            <label class="form-check-label" for="billCredit">Credit</label>
                        </div>

                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="inlineRadioOptions" id="billCash" value="Cash" />
                            <label class="form-check-label" for="billCash">Cash</label>
                        </div>
                    </div>

                    <div>

                        <label class="form-label mt-3" style="color:black"> Total Amount</label>
                        <input type="text" class="form-control" name="" id="billTotalAmount">
                    </div>



                </div>
               <div class="row">
                <div class="col mt-4" style="text-align: end;">
                    <button class="btn mt-3 text-white billItemAdding" type="submit" id="billCustomerAdding" style="
                                    width: 150px ;background-color: #55acee;
                                ">
                        Add &nbsp;<i class="fa fa-chevron-circle-right" style="font: size 22px;"></i>
                    </button>
                </div>
                <div class="col mt-4" style="text-align: start;">
                        <button class="btn text-white mt-3 " id="billCustomerAdding" style="
                                width: 150px; background-color: #344e41;
                            " type="button">
                        Clear &nbsp; <i class="fa fa-trash-o" style="font-size:17px"></i>
                    </button>
                </div>
                </div>
                
            </div>
            <hr>
            <div class="row mt-3  shadow p-3 mb-5 bg-white rounded" style=" border: 3px solid #fff;">
                <div class="row mt-3">
                    <div class="col-3">
                        <div class="ui-widget">
                            <label class="form-label mt-2" for="billItemCode" style="color:black">Item Code</label>
                            <input type="text" class=" form-control  " id="billItemCode" placeholder="Select ItemCode" />
                        </div>
                    </div>
                    <div class="col-3">
                        
                            <label class="form-label mt-2" style="color:black">Item Name</label>

                           
                        <input type="text" class="form-control" name="strGstRate" id="billItemName">
                     
                    </div>
                    <div class="col-2">
                        <label class="form-label mt-2" style="color:black">Rate</label>
                        <input type="text" class="form-control" name="strGstRate" id="billItemRate">

                    </div>
                    <div class="col-2">
                        <label class="form-label mt-2" style="color:black">Quantity</label>
                        <input type="number" class="form-control" name="billItemQuantity" id="billItemQuantity">

                    </div>
                    <div class="col-2">
                        <label class="form-label mt-2" style="color:black">Value</label>
                        <input type="text" class="form-control" name="billItemValue" id="billItemValue">

                    </div>
                </div>

                <div class="row mt-3 mb-4">
                    <div class="col-2  mt-2">
                        <label class="form-label" style="color:black">GST %</label>
                        <input type="text" class="form-control" name="billItemGst" id="billItemGst">

                    </div>
                    <div class="col-2 mt-2">
                        <label class="form-label " style="color:black">GST Value</label>
                        <input type="text" class="form-control" name="billItemGstValue" id="billItemGstValue">

                    </div>
                    <div class="col-2 mt-2">
                        <label class="form-label " style="color:black">Amount</label>
                        <input type="text" class="form-control" name="billItemAmount" id="billItemAmount">

                    </div>
                    <div class="col mt-4" style="text-align: end;">
                        <button class="btn mt-3 text-white billItemAdding d-none" type="submit" id="billItemUpdate" style="
                                    width: 150px ;background-color: #66747e;
                                ">
                            update &nbsp;<i class="fa fa-chevron-circle-right" style="font: size 22px;"></i>
                        </button>
                        <button class="btn mt-3 text-white billItemAdding" type="submit" id="billItemAdding" style="
                                    width: 150px ;background-color: #55acee;
                                ">
                            Add &nbsp;<i class="fa fa-chevron-circle-right" style="font: size 22px;"></i>
                        </button>
                        <button class="btn text-white mt-3 " id="billItemClear" style="
                                width: 150px; background-color: #344e41;
                            " type="button">
                            Clear &nbsp; <i class="fa fa-trash-o" style="font-size:17px"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <hr>
        <div class="row  shadow p-3 mb-5 bg-white rounded">
            <div class="col mt-5">
                <table class="table" id="BillingTable">

                    <thead>
                        <tr>
                            <th>Item Code</th>
                            <th>Item Name</th>
                            <th>Quantity</th>
                            <th>Rate</th>
                            <th>Value</th>
                            <th>GST %</th>
                            <th>GST Value</th>
                            <th>Total</th>
                            <th>Edit</th>
                            <th> Delete</th>
                        </tr>
                    </thead>
                    <tbody id="itemTableBody">
                    </tbody>

                </table>
            </div>

        </div>
        <hr>
        <div class="row mt-3 mb-4">
            <div class="col-2  mt-2">
                <label class="form-label" style="color:black">Total Value</label>
                <input type="text" class="form-control" name="TotalVal" id="TotalVal">

            </div>
            <div class="col-2 mt-2">
                <label class="form-label " style="color:black">Total GST Value</label>
                <input type="text" class="form-control" name="totalGstValue" id="totalGstRate">

            </div>
            <div class="col-2 mt-2">
                <label class="form-label " style="color:black">Total Amount</label>
                <input type="text" class="form-control" name="totalAmt" id="totalAmt">

            </div>
            <div class="col mt-4" style="text-align: end;">
                <button class="btn mt-3 text-white billCustomerAdding" type="submit" id="billCustomerAdding" style="
                           width: 150px ;background-color: #55acee;
                       ">
                    Add &nbsp;<i class="fa fa-chevron-circle-right" style="font: size 22px;"></i>
                </button>
                <button class="btn text-white mt-3 " id="stuFirstFormClear" style="
                       width: 150px; background-color: #344e41;
                   " type="button">
                    Clear &nbsp; <i class="fa fa-trash-o" style="font-size:17px"></i>
                </button>
            </div>
        </div>
       
  </div>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/additional-methods.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.8/jquery.inputmask.min.js"></script>
    <script>
        $(document).ready(function () {
            
            $('#billCustomerOutstandingAmount').prop('readonly', true);
            $('#billCustomerOutstandingLimit').prop('readonly', true);
            $('#billNumber').prop('readonly', true);
            $('#billCustomerDetails').prop('readonly', true);
            $('#billItemName').prop('readonly', true);
            $('#billItemRate').prop('readonly', true);
            $('#billItemGst').prop('readonly', true);
            $('#billItemValue').prop('readonly', true);
            $('#billItemGstValue').prop('readonly', true);
            $('#billItemAmount').prop('readonly', true);
            $('#TotalVal').prop('readonly', true);
            $('#totalGstRate').prop('readonly', true);
            $('#totalAmt').prop('readonly', true);
            
            $("#billDate").datepicker({  
                dateFormat: 'dd-mm-yy',     
                onSelect: function (dateText) {
                }
            });
            var currentDate = new Date(); 
            $("#billDate").datepicker('setDate', currentDate);
            $('#billTotalAmount').prop('readonly', true);
            var CustomerTable = $('#BillingTable').DataTable();

            var apiUrl = "@ViewBag.ApiUrl"
            var id = 0;
            var customerNameList = [ ];
            var customerlist = {
               
            };
            var itemCodeList = [];
            var itemList ={

            };
             $.ajax({
                url: apiUrl + "customer?customerId=" + id,
                type: "GET",
                success: function (response) {
                    var response = response.data;
                    console.log(response);
                    $.each(response, function (index, customer) {
                        customerNameList.push(customer.customerName);
                        customerlist[customer.customerName]=customer.customerId;

                    });
                },
                error: function (e) {
                    console.error("Error retrieving items: " + e);
                }
            });
              $.ajax({
                url: apiUrl + "item?ItemId = "+ id,
                type: "GET",
                success: function (response) {
                   
                    var response = response.data;
                    console.log(response.data);
                    $.each(response, function (index, item) {
                        itemCodeList.push(item.itemCode);
                        itemList[item.itemCode]= item.itemId;
                       
                    })
                },
                error: function (e) {
                    console.error("Error retrieving items: " + e);
                }
            });
            $.ajax({
                url: apiUrl +"Billservice?billno=none",
                type: "GET",
                success: function(response){
                    var billnumber = response.data;
                    console.log(billnumber);
                    $('#billNumber').val(billnumber[0].billNo)
                },
                error: function (e) {
                    console.error("Error retrieving items: " + e);
                }

            });
        
            console.log(customerNameList);
            console.log(itemCodeList);
            console.log(itemList);
            console.log(customerlist);

           
            $("#billcustomernameTags").on("focus", function () {
                $(this).autocomplete("search", "");
            });
             $("#billcustomernameTags").autocomplete({
                source: customerNameList,
                minLength: 0,
                autoFocus: true
               
            });


            $("#billItemCode").on("focus", function () {
                $(this).autocomplete("search", "");
            });

             $("#billItemCode").autocomplete({
                source: itemCodeList,
                minLength: 0,
                autoFocus: true
            });

            
           

            $('#billcustomernameTags').blur(function () {
                const customerOption = $(this).val()

                // Get the ID of the selected option
                //const customerId = customerOption.attr('id');
                var customerId = customerlist[customerOption]

                console.log(customerOption);
                console.log(customerId);
                $.ajax({
                    url: apiUrl + "customer?customerId=" + customerId,
                    type: "GET",
                    success: function (response) {
                        var response = response.data;
                        console.log(response);
                        $.each(response, function (index, customer) {

                            $('#billCustomerOutstandingAmount').val(customer.outstandingAmount);
                            $('#billCustomerOutstandingLimit').val(customer.outstandingLimit);
                            $('#billCustomerDetails').val(customer.address);
                           
                        });
                    },
                    error: function (e) {
                        console.error("Error retrieving items: " + e);
                    }
                });
               if (customerOption === customerOption) {
                   $('#billCustomerOutstandingAmount').val(' ');
                   $('#billCustomerOutstandingLimit').val(" ");
                    $('#billCustomerDetails').val(" ");

               }
            });
            $("#billItemCode").blur(function () {

                const itemCodeOption = $(this).val()
                var id = itemList[itemCodeOption];
                console.log(id)
                id =parseInt(id);
                $('#billItemValue').val("");
                $('#billItemGstValue').val("");
                $('#billItemAmount').val("");
                $('#billItemQuantity').val("");
            
                $.ajax({
                    url: apiUrl +"item?ItemId=" + id,
                    type: "GET",
                    success: function (response) {
                        var itemResponse = response.data;
                        console.log(itemResponse);
                        $.each(itemResponse, function (index, response) {

                           $('#billItemName').val(response.itemName)
                          $('#billItemRate').val(response.price)
                            $('#billItemGst').val(response.gst)
                        });
                    }
                })
            });
            $("#billItemQuantity").blur(function () {
                var quantity = $(this).val();
                var price = $('#billItemRate').val();
                var value = quantity * price;
                $('#billItemValue').val(value);
                var billItemGst = $('#billItemGst').val();
                var GSTAmount = (value * billItemGst) / 100;
                
                $('#billItemGstValue').val(GSTAmount);
                var total = value + GSTAmount;
                $('#billItemAmount').val(total);

                var billCustomerOutstandingLimit = parseInt($('#billCustomerOutstandingLimit').val());
                var totalAmt = parseInt( $('#totalAmt').val());
                 totalAmt +=total;
                if (billCustomerOutstandingLimit < total){
                    Swal.fire('your outstanding limit has been exceed');
                    $('#billItemAdding').prop('disabled', true);

                }
                
                else if (billCustomerOutstandingLimit < totalAmt) {
                    Swal.fire('your outstanding total limit has been exceed');
                    $('#billItemAdding').prop('disabled', true);
                } 
                else{
                    $('#billItemAdding').prop('disabled', false);

                }

            
            });
           var itemIdEdit = 0;
            var itemBillNo = 1;
            $('#billItemUpdate').click(function () {
               
                

                // Retrieve the edited data from the form inputs
               // var billItemName = $('#billItemName').val();
               // var billItemCode = $('#billItemCode').val();
              //  var billItemQuantity = $('#billItemQuantity').val();
              //  var billItemValue = $('#billItemValue').val();
               // var billItemRate = $('#billItemRate').val();
               // var billItemGst = $('#billItemGst').val();
               // var billItemGstValue = $('#billItemGstValue').val();
               /// var billItemAmount = $('#billItemAmount').val();
               /// var dataTable = $('#BillingTable').DataTable();
               // var rowIndex = dataTable.row('#' + billItemCode).index();
               
               // dataTable.cell(rowIndex, 1).data(billItemName);
               // dataTable.cell(rowIndex, 2).data(billItemQuantity);
              //  dataTable.cell(rowIndex, 3).data(billItemValue);
               // dataTable.cell(rowIndex, 4).data(billItemRate);
               // dataTable.cell(rowIndex, 5).data(billItemGst);
               // dataTable.cell(rowIndex, 6).data(billItemGstValue);
               // dataTable.cell(rowIndex, 7).data(billItemAmount);

                // Redraw the DataTable to reflect the updated data
                //dataTable.draw();

                var billItemName = $('#billItemName').val();
                var billItemCode = $('#billItemCode').val();
                var billItemQuantity = $('#billItemQuantity').val();
                var billItemValue = $('#billItemValue').val();
                var billItemRate = $('#billItemRate').val();
                var billItemGst = $('#billItemGst').val();
                var billItemGstValue = $('#billItemGstValue').val();
                var billItemAmount = $('#billItemAmount').val();
                var dataTable = $('#BillingTable').DataTable();
                dataTable.clear().draw();
                var customerItemBill = {
                    ItemId:itemIdEdit,
                    ItemName: billItemName,
                    ItemCode: billItemCode,
                    Price: billItemRate,
                    Stock: billItemQuantity,
                    GST: billItemGst,
                    Value: billItemValue,
                    GSTValue: billItemGstValue,
                    Amount: billItemAmount,
                    Mode: "UPDATE",
                    BillNo: itemBillNo
                }
                var result = 0;
                $.ajax({
                    url: apiUrl + "Billservice/ItemBill",
                    type: "POST",
                    data: JSON.stringify(customerItemBill),
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function (response) {
                        var billId = response.data;
                        console.log("Item saved successfully:", billId);
                        Swal.fire('Item Updated successfully');
                        result += 1;
                    },
                    error: function (e) {

                        console.log("Error Updating data:", e);
                    }
                });
                debugger
                if (result != 0) {
                    alert("now")
                } else {
                    console.log(itemBillNo);
                    var billNo = parseInt(itemBillNo);
                    $.ajax({
                        url: apiUrl + "Billservice/ItemBill?billNo=" + billNo,
                        type: "GET",
                        success: function (response) {
                            var response = response.data;
                            var grandtota = 0;
                            var TotalVal = 0;
                            var totalGstRate = 0;
                            $.each(response, function (index, billId) {
                                var len = dataTable.data().length + 1;
                                var row = "<tr id= " + billId.itemId + " >" +
                                    "<td >" + billId.itemCode + "</td>" +
                                    "<td>" + billId.itemName + "</td>" +
                                    "<td>" + billId.stock + "</td>" +
                                    "<td>" + billId.price + "</td>" +
                                    "<td>" + billId.value + "</td>" +
                                    "<td>" + billId.gst + "</td>" +
                                    "<td>" + billId.gstValue + "</td>" +
                                    "<td>" + billId.amount + "</td>" +
                                    "<td><a type='button' class='btn btn-sm text-white' id='BillingTableEdit' style='background-color: #55acee;'><i class='fa fa-edit' style='font-size:16px'></i></a></td>" +
                                    "<td><a type='button' data-toggle='modal' class='btn btn-sm text-white BillingTableDeleteBtn' id='BillingTableDelete' style='background-color: #c61118;'><i class='fa fa-trash-o' style='font-size:16px'></i></a></td>" +
                                    "</tr>";
                                dataTable.row.add($(row));
                                dataTable.draw();
                                grandtota += parseFloat(billId.amount)
                                totalGstRate += parseInt(billId.gstValue)
                                TotalVal += parseFloat(billId.value)
                                // grandtotal += parseFloat(billId.amount);

                                $('#billTotalAmount').val(grandtota);
                                $('#totalAmt').val(grandtota);
                                $('#totalGstRate').val(totalGstRate);
                                $('#TotalVal').val(TotalVal);

                            });
                            console.log("Item geting successfully:", response);
                        },
                        error: function (e) {

                            console.log("Error saving data:", e);
                        }
                    });
                }




                $('#billItemName').val(" ");
                $('#billItemCode').val("");
                $('#billItemQuantity').val("");
                $('#billItemValue').val("");
                $('#billItemRate').val("");
                $('#billItemGst').val("");
                $('#billItemGstValue').val("");
                $('#billItemAmount').val("");



                $('#billItemUpdate').addClass('d-none');
                $('#billItemAdding').removeClass('d-none');
                $('#billItemName').val(" ");
                $('#billItemCode').val("");
                $('#billItemQuantity').val("");
                $('#billItemValue').val("");
                $('#billItemRate').val("");
                $('#billItemGst').val("");
                $('#billItemGstValue').val("");
                $('#billItemAmount').val("");
                
                dataTable.rows().every(function () {
                    var rowData = this.data();

                    // Get the value from the "Total" column (index 7)
                    var totalValue = Number(rowData[4]);
                    var totalGstValue = Number(rowData[6]);

                    // Add the total value to the sum
                    totalSum += totalValue;
                    totalGst += totalGstValue;

                    grandTotal = totalSum + totalGst;

                });
            });
            $(document).on('click', '#BillingTableEdit', function () {
                 itemIdEdit = $(this).closest('tr').attr('id');
                console.log(itemIdEdit);
                var billItemCode = $("#" + itemIdEdit + " td:nth-child(1)").text().trim();
                var billItemName = $("#" + itemIdEdit + " td:nth-child(2)").text().trim();
                var billItemQuantity = $("#" + itemIdEdit + " td:nth-child(3)").text().trim();
                var billItemValue = $("#" + itemIdEdit + " td:nth-child(4)").text().trim();
                var billItemRate = $("#" + itemIdEdit + " td:nth-child(5)").text().trim();
                var billItemGst = $("#" + itemIdEdit + " td:nth-child(6)").text().trim();
                var billItemGstValue = $("#" + itemIdEdit + " td:nth-child(7)").text().trim();
                var billItemAmount = $("#" + itemIdEdit + " td:nth-child(8)").text().trim();
                $('#billItemName').val(billItemName);
                $('#billItemCode').val(billItemCode);
                $('#billItemQuantity').val(billItemQuantity);
                $('#billItemRate').val(billItemValue);
                $('#billItemValue').val(billItemRate);
                $('#billItemGst').val(billItemGst);
                $('#billItemGstValue').val(billItemGstValue);
                $('#billItemAmount').val(billItemAmount);

                $('#billItemUpdate').removeClass('d-none');
                $('#billItemAdding').addClass('d-none');
               

            })
            
            $(document).on('click', '#BillingTableDelete', function () {
                var id = $(this).closest('tr').attr('id');
                console.log(id);
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire(
                            'Deleted!',
                            'Your ItemBill has been deleted.',
                            'success'
                        )
                    }
                })

                $('.swal2-confirm').click(function () {
                    console.log(id);

                    $.ajax({
                        url: apiUrl + "Billservice/ItemBill?billNo=" + id,
                        type: "DELETE",
                        success: function (response) {

                            console.log("Your ItemBill has been deleted.:", response);
                        },
                        error: function (e) {

                            console.log("Error  has been delete.:", e);
                        }
                    });


                    var dataTable = $('#BillingTable').DataTable();
                    var deletedRowIndex = dataTable.row(id).index();
                    dataTable.row('#' + id).remove().draw();
                    dataTable.rows().every(function (rowIdx, tableLoop, rowLoop) {
                        var currentRow = this.node();
                        var currentSerialNumber = rowLoop + 1;
                        $(currentRow).find('td:first').text(currentSerialNumber);
                    });

                    var totalSum = 0;
                    var totalGst = 0;

                    var grandTotal = 0;
                    dataTable.rows().every(function () {
                        var rowData = this.data();

                        // Get the value from the "Total" column (index 7)
                        var totalValue = Number(rowData[4]);
                        var totalGstValue = Number(rowData[6]);

                        // Add the total value to the sum
                        totalSum += totalValue;
                        totalGst += totalGstValue;

                        grandTotal = totalSum + totalGst;

                    });

                    $('#TotalVal').val(totalSum);
                    $('#totalGstRate').val(totalGst);
                    $('#totalAmt').val(grandTotal);
                    $('#TotalAmount').val(grandTotal);
                    
                });
            });
            
            

            $('#billCustomerAdding').click(function(){

        
                var billcustomernameTags = $('#billcustomernameTags').val();
                var billCustomerOutstandingAmount = $('#billCustomerOutstandingAmount').val();
                 billCustomerOutstandingLimit = $('#billCustomerOutstandingLimit').val();
                var billCustomerDetails = $('#billCustomerDetails').val();
                var billNumber = $('#billNumber').val();
                var billDate = $('#billDate').val();
                var billPayment = $("input[name='inlineRadioOptions']:checked").val();
                var TotalAmount = $('#billTotalAmount').val();
                

                var customerBill = {
                    CustomerName: billcustomernameTags,
                    OutstandingAmount: billCustomerOutstandingAmount,
                    OutstandingLimit: billCustomerOutstandingLimit,
                    CustomerDetails: billCustomerDetails,
                    BillDate: billDate,
                    PaymentType: billPayment,
                    Mode: "INSERT",
                    TotalAmount: 0,
                    Billno: billNumber
                }
                //alert(customerBill.Billno);
                //alert(apiUrl + "Billservice");
               
                 $.ajax({
                    url: apiUrl + "Billservice",
                    type:"POST",
                    data: JSON.stringify(customerBill),
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function (response) {
                        // Handle success response
                        var billId = response.data;
                        itemBillNo = billId.billId;
                        console.log("Data saved successfully:", itemBillNo);
                        Swal.fire('Data saved successfully Your BillId is ' + itemBillNo);
                    },
                    error: function (e) {
                        // Handle error response
                        console.log("Error saving data:", e);
                    }
                 });
                   
            })
            //var billCustomerOutstandingLimit = 0;
            var grandtotal = 0;
            
            $('#billItemAdding').click(function () {

                var billItemName = $('#billItemName').val();
                var billItemCode = $('#billItemCode').val();
                var billItemQuantity = $('#billItemQuantity').val();
                var billItemValue = $('#billItemValue').val();
                var billItemRate = $('#billItemRate').val();
                var billItemGst = $('#billItemGst').val();
                var billItemGstValue = $('#billItemGstValue').val();
                var billItemAmount = $('#billItemAmount').val();
                    var dataTable = $('#BillingTable').DataTable();
                    dataTable.clear().draw();
                    var customerItemBill = {
                        ItemName: billItemName,
                        ItemCode: billItemCode,
                        Price: billItemRate,
                        Stock: billItemQuantity,
                        GST: billItemGst,
                        Value: billItemValue,
                        GSTValue: billItemGstValue,
                        Amount: billItemAmount,
                        Mode: "INSERT",
                        BillNo: itemBillNo
                    }
                    var result = 0;
                    $.ajax({
                        url: apiUrl + "Billservice/ItemBill",
                        type: "POST",
                        data: JSON.stringify(customerItemBill),
                        dataType: 'json',
                        contentType: 'application/json',
                        success: function (response) {
                            var billId = response.data;
                            console.log("Item saved successfully:", billId);
                            Swal.fire('Item saved successfully');
                           result+=1;
                        },
                        error: function (e) {

                            console.log("Error saving data:", e);
                        }
                    });
                   debugger
                    if(result !=0){
                    alert("now")
                    }else{
                        
                        var billNo = parseInt(itemBillNo);
                      $.ajax({
                        url: apiUrl + "Billservice/ItemBill?billNo=" + billNo,
                        type: "GET",
                        success: function (response) {
                            var response = response.data;
                            var grandtota =0;
                            var TotalVal=0;
                            var totalGstRate =0;
                            $.each(response, function (index, billId) {
                                var len = dataTable.data().length + 1;
                                var row = "<tr id= " + billId.itemId + " >" +
                                    "<td >" +  billId.itemCode+"</td>" +
                                    "<td>" + billId.itemName + "</td>" +
                                    "<td>" + billId.stock + "</td>" +
                                    "<td>" + billId.price + "</td>" +
                                    "<td>" + billId.value + "</td>" +
                                    "<td>" + billId.gst + "</td>" +
                                    "<td>" + billId.gstValue + "</td>" +
                                    "<td>" + billId.amount + "</td>" +
                                    "<td><a type='button' class='btn btn-sm text-white' id='BillingTableEdit' style='background-color: #55acee;'><i class='fa fa-edit' style='font-size:16px'></i></a></td>" +
                                    "<td><a type='button' data-toggle='modal' class='btn btn-sm text-white BillingTableDeleteBtn' id='BillingTableDelete' style='background-color: #c61118;'><i class='fa fa-trash-o' style='font-size:16px'></i></a></td>" +
                                    "</tr>";
                                dataTable.row.add($(row));
                                dataTable.draw();
                                grandtota += parseFloat(billId.amount)
                                totalGstRate +=parseInt(billId.gstValue)
                                TotalVal += parseFloat(billId.value)
                                // grandtotal += parseFloat(billId.amount);
                                
                                $('#billTotalAmount').val(grandtota);
                                $('#totalAmt').val(grandtota);
                                $('#totalGstRate').val(totalGstRate);
                                $('#TotalVal').val(TotalVal);
                                
                            });
                            console.log("Item geting successfully:", response);
                        },
                        error: function (e) {

                            console.log("Error saving data:", e);
                        }
                     });
                    }
                
                
               

                $('#billItemName').val(" ");
                $('#billItemCode').val("");
                $('#billItemQuantity').val("");
                $('#billItemValue').val("");
                $('#billItemRate').val("");
                $('#billItemGst').val("");
                $('#billItemGstValue').val("");
                $('#billItemAmount').val("");


            });
          
        });
       
    </script>
</body>

               